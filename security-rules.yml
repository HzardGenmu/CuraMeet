rules:
  # =========================================================
  # 1. SQL INJECTION (SQLi) - Backend (Laravel)
  # =========================================================

  - id: laravel-raw-sql-concatenation
    patterns:
      - pattern-either:
          # Mendeteksi konkatenasi string di dalam method raw
          - pattern: DB::raw("..." . $VAR . "...")
          - pattern: DB::statement("..." . $VAR . "...")
          - pattern: DB::select("..." . $VAR . "...")
          - pattern: $MODEL::whereRaw("..." . $VAR . "...")
          - pattern: $MODEL::selectRaw("..." . $VAR . "...")
    message: |
      POTENSI SQL INJECTION: Terdeteksi penggabungan variabel PHP langsung ke dalam query SQL mentah.
      Jangan pernah menyambung string untuk query. Gunakan 'parameter binding' (tanda tanya ?).
      Contoh aman: whereRaw('age > ?', [$age])
    languages: [php]
    severity: ERROR

  - id: laravel-raw-order-by
    pattern: $Q->orderByRaw($VAR)
    message: |
      POTENSI SQL INJECTION: orderByRaw sering menjadi target serangan jika input user masuk langsung.
      Validasi input user terhadap daftar kolom yang diizinkan (whitelist) sebelum memasukkannya ke sini.
    languages: [php]
    severity: WARNING

  # =========================================================
  # 2. CROSS-SITE SCRIPTING (XSS) - Frontend (React) & Backend
  # =========================================================

  - id: react-dangerously-set-inner-html
    patterns:
      - pattern: <$TAG dangerouslySetInnerHTML={{ __html: ... }} ... />
    message: |
      XSS RISK: Penggunaan 'dangerouslySetInnerHTML' memungkinkan injeksi skrip berbahaya.
      Hanya gunakan jika konten benar-benar terpercaya atau sudah disanitasi menggunakan library seperti 'dompurify'.
    languages: [javascript, typescript, typescriptreact, javascriptreact]
    severity: ERROR

  - id: react-href-javascript-protocol
    patterns:
      - pattern: <a href="javascript:...">
      - pattern: <a href={"javascript:" + ...}>
    message: |
      XSS RISK: Menggunakan protokol 'javascript:' pada href memungkinkan eksekusi skrip sembarang.
      Gunakan event handler React seperti 'onClick' untuk logika interaktif.
    languages: [javascript, typescript, typescriptreact, javascriptreact]
    severity: ERROR

  - id: react-untrusted-url-in-img
    pattern: <img src={...} ... />
    message: |
      XSS/PHISHING RISK: Pastikan sumber gambar (src) divalidasi jika berasal dari input user.
      User jahat bisa menyisipkan URL berbahaya atau tracking pixel.
    languages: [javascript, typescript, typescriptreact, javascriptreact]
    severity: INFO

  - id: laravel-blade-unescaped-output
    # Note: Semgrep men-scan file .blade.php sebagai teks/generic jika tidak diset khusus,
    # tapi rule ini bekerja jika extension .blade.php dianggap file ter-scan.
    patterns:
      - pattern: "{!! $VAR !!}"
    paths:
      include:
        - "*.blade.php"
    message: |
      XSS RISK: Output {!! !!} di Blade tidak melakukan escaping HTML.
      Jika variabel ini berasal dari input user, script jahat akan dieksekusi.
      Gunakan {{ }} kecuali Anda yakin data tersebut aman/sudah disanitasi (misal: HTML Purifier).
    languages: [generic] # Menggunakan mode generic text search untuk blade
    severity: WARNING

  # =========================================================
  # 3. BROKEN ACCESS CONTROL (BAC) & IDOR - Backend (Laravel)
  # =========================================================

  - id: laravel-mass-assignment-vulnerability
    patterns:
      - pattern: $MODEL::create($REQ->all())
      - pattern: $MODEL->update($REQ->all())
      - pattern: $MODEL::create($REQ->input())
    message: |
      BROKEN ACCESS CONTROL (Integrity): Menggunakan $request->all() langsung ke database berbahaya.
      User bisa mengirim field tersembunyi (misal: 'is_admin': 1) untuk menaikkan hak akses.
      Gunakan $request->only(['field1', 'field2']) atau $request->validated().
    languages: [php]
    severity: WARNING

  - id: laravel-missing-authorization-check
    patterns:
      - pattern: |
          public function update(..., $id) {
            ...
            $MODEL = $M::find($id);
            ...
            $MODEL->update(...);
          }
      - pattern: |
          public function destroy(..., $id) {
            ...
            $MODEL = $M::find($id);
            ...
            $MODEL->delete();
          }
    pattern-not: |
        public function $FUNC(..., $id) {
            ...
            $this->authorize(...);
            ...
        }
    message: |
      POTENSI BROKEN ACCESS CONTROL (IDOR): Method update/delete ditemukan tanpa pemanggilan '$this->authorize()' atau penggunaan Policy.
      Pastikan Anda mengecek apakah user yang sedang login BERHAK mengubah data ID tersebut.
    languages: [php]
    severity: WARNING

  - id: laravel-ignoring-auth-id
    patterns:
      - pattern: |
          $MODEL->user_id = $REQ->input('user_id');
      - pattern: |
          $MODEL->user_id = $REQ->get('user_id');
    message: |
      POTENSI IDOR: Mengambil 'user_id' dari input request untuk disimpan ke database.
      Jangan percaya input user untuk menentukan kepemilikan data.
      Gunakan Auth::id() atau $request->user()->id untuk mendapatkan ID user yang sedang login secara aman.
    languages: [php]
    severity: ERROR

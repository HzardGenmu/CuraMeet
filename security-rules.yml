rules:
  # =========================================================
  # 1. SQL INJECTION (SQLi) - Backend (Laravel)
  # =========================================================

  - id: laravel-raw-sql-concatenation
    patterns:
      - pattern-either:
          # Gunakan tanda kutip untuk pattern yang mengandung karakter spesial
          - pattern: 'DB::raw("..." . $VAR . "...")'
          - pattern: 'DB::statement("..." . $VAR . "...")'
          - pattern: 'DB::select("..." . $VAR . "...")'
          - pattern: '$MODEL::whereRaw("..." . $VAR . "...")'
          - pattern: '$MODEL::selectRaw("..." . $VAR . "...")'
    message: |
      POTENSI SQL INJECTION: Terdeteksi penggabungan variabel PHP langsung ke dalam query SQL mentah.
      Jangan pernah menyambung string untuk query. Gunakan 'parameter binding' (tanda tanya ?).
      Contoh aman: whereRaw('age > ?', [$age])
    languages: [php]
    severity: ERROR

  - id: laravel-raw-order-by
    pattern: $Q->orderByRaw($VAR)
    message: |
      POTENSI SQL INJECTION: orderByRaw sering menjadi target serangan jika input user masuk langsung.
      Validasi input user terhadap daftar kolom yang diizinkan (whitelist) sebelum memasukkannya ke sini.
    languages: [php]
    severity: WARNING

  # =========================================================
  # 2. CROSS-SITE SCRIPTING (XSS) - Frontend (React) & Backend
  # =========================================================

  - id: react-dangerously-set-inner-html
    patterns:
      # WAJIB PAKAI KUTIP DI SINI KARENA ADA ":" DI DALAM {{ }}
      - pattern: "<$TAG dangerouslySetInnerHTML={{ __html: ... }} ... />"
    message: |
      XSS RISK: Penggunaan 'dangerouslySetInnerHTML' memungkinkan injeksi skrip berbahaya.
      Hanya gunakan jika konten benar-benar terpercaya atau sudah disanitasi menggunakan library seperti 'dompurify'.
    languages: [javascript, typescript, typescriptreact, javascriptreact]
    severity: ERROR

  - id: react-href-javascript-protocol
    patterns:
      - pattern: '<a href="javascript:...">'
      - pattern: '<a href={"javascript:" + ...}>'
    message: |
      XSS RISK: Menggunakan protokol 'javascript:' pada href memungkinkan eksekusi skrip sembarang.
      Gunakan event handler React seperti 'onClick' untuk logika interaktif.
    languages: [javascript, typescript, typescriptreact, javascriptreact]
    severity: ERROR

  - id: react-untrusted-url-in-img
    pattern: '<img src={...} ... />'
    message: |
      XSS/PHISHING RISK: Pastikan sumber gambar (src) divalidasi jika berasal dari input user.
      User jahat bisa menyisipkan URL berbahaya atau tracking pixel.
    languages: [javascript, typescript, typescriptreact, javascriptreact]
    severity: INFO

  - id: laravel-blade-unescaped-output
    patterns:
      - pattern: "{!! $VAR !!}"
    paths:
      include:
        - "*.blade.php"
    message: |
      XSS RISK: Output {!! !!} di Blade tidak melakukan escaping HTML.
      Jika variabel ini berasal dari input user, script jahat akan dieksekusi.
      Gunakan {{ }} kecuali Anda yakin data tersebut aman/sudah disanitasi.
    languages: [generic]
    severity: WARNING

  # =========================================================
  # 3. BROKEN ACCESS CONTROL (BAC) & IDOR - Backend (Laravel)
  # =========================================================

  - id: laravel-mass-assignment-vulnerability
    patterns:
      - pattern: $MODEL::create($REQ->all())
      - pattern: $MODEL->update($REQ->all())
      - pattern: $MODEL::create($REQ->input())
    message: |
      BROKEN ACCESS CONTROL (Integrity): Menggunakan $request->all() langsung ke database berbahaya.
      Gunakan $request->only(['field1', 'field2']) atau $request->validated().
    languages: [php]
    severity: WARNING

  - id: laravel-missing-authorization-check
    patterns:
      - pattern: |
          public function update(..., $id) {
            ...
            $MODEL = $M::find($id);
            ...
            $MODEL->update(...);
          }
      - pattern: |
          public function destroy(..., $id) {
            ...
            $MODEL = $M::find($id);
            ...
            $MODEL->delete();
          }
    pattern-not: |
        public function $FUNC(..., $id) {
            ...
            $this->authorize(...);
            ...
        }
    message: |
      POTENSI BROKEN ACCESS CONTROL (IDOR): Method update/delete ditemukan tanpa pemanggilan '$this->authorize()'.
    languages: [php]
    severity: WARNING

  - id: laravel-ignoring-auth-id
    patterns:
      - pattern: |
          $MODEL->user_id = $REQ->input('user_id');
      - pattern: |
          $MODEL->user_id = $REQ->get('user_id');
    message: |
      POTENSI IDOR: Mengambil 'user_id' dari input request untuk disimpan ke database.
      Gunakan Auth::id() atau $request->user()->id.
    languages: [php]
    severity: ERROR
